<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Content Booster</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>YouTube 컨텐츠 부스터</h1>
    <p>키워드를 입력하여 최신 트렌드 영상을 확인하세요.</p>
    <input type="text" id="searchInput" placeholder="검색어를 입력하세요">
    <button onclick="searchVideos()">검색</button>

    <div id="results"></div>

    <script>
    async function searchVideos() {
        const query = document.getElementById('searchInput').value;
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        const publishedAfter = oneMonthAgo.toISOString();

        try {
            const response = await fetch(`/.netlify/functions/search?q=${query}&publishedAfter=${publishedAfter}&order=viewCount`);
            const data = await response.json();

            if (!data || data.length === 0) {
                console.log('검색 결과가 없습니다.');
                return;
            }

            const videoIds = data.items.map(item => item.id.videoId).join(',');
            const videoDetailsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?key=YOUR_API_KEY&part=snippet,statistics&id=${videoIds}`);
            const videoDetails = await videoDetailsResponse.json();

            const videoData = [];

            videoDetails.items.forEach(item => {
                const title = item.snippet.title;
                const videoId = item.id;
                const url = `https://www.youtube.com/watch?v=${videoId}`;
                const viewCount = parseInt(item.statistics.viewCount);
                const likeCount = item.statistics.likeCount || 0;
                const publishedAt = new Date(item.snippet.publishedAt).toLocaleDateString();
                const channelId = item.snippet.channelId;
                const thumbnailUrl = item.snippet.thumbnails.default.url;
                const hashtags = item.snippet.tags ? item.snippet.tags.join(', ') : '';

                const subscriberCount = item.statistics.subscriberCount || 0;
                const subGrowthRate = (subscriberCount / (subscriberCount + viewCount + 0.1)) * 100;

                // Hit 영상 조건: 조회수가 구독자 수의 두 배 이상이거나, 구독자 성장률이 양수
                const isHit = viewCount > subscriberCount * 2 || subGrowthRate > 0;

                videoData.push({
                    title,
                    url,
                    viewCount,
                    likeCount,
                    publishedAt,
                    thumbnailUrl,
                    hashtags,
                    isHit
                });
            });

            // 조회수 기준으로 정렬
            videoData.sort((a, b) => b.viewCount - a.viewCount);

            displayResults(videoData);
        } catch (error) {
            console.error('검색 중 오류 발생:', error);
        }
    }

    function displayResults(videos) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        const table = document.createElement('table');
        table.classList.add('results-table');

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
            <th>Thumbnail</th>
            <th>Title</th>
            <th>View Count</th>
            <th>Published At</th>
            <th>Hit 여부</th>
        `;
        table.appendChild(headerRow);

        videos.forEach(video => {
            const row = document.createElement('tr');
            row.classList.add('result-row');

            row.innerHTML = `
                <td><img src="${video.thumbnailUrl}" alt="thumbnail"></td>
                <td><a href="${video.url}" target="_blank">${video.title}</a></td>
                <td>${video.viewCount.toLocaleString()}</td>
                <td>${video.publishedAt}</td>
                <td>${video.isHit ? 'Hit' : ''}</td>
            `;

            table.appendChild(row);
        });

        resultsDiv.appendChild(table);
    }
    </script>
</body>
</html>
